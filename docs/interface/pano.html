<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.9.2" />
<title>src.interface.pano API documentation</title>
<meta name="description" content="외피 열화상 파노라마 영상처리 알고리즘의 CLI 인터페이스" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>src.interface.pano</code></h1>
</header>
<section id="section-intro">
<p>외피 열화상 파노라마 영상처리 알고리즘의 CLI 인터페이스</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;
외피 열화상 파노라마 영상처리 알고리즘의 CLI 인터페이스
&#34;&#34;&#34;
from pathlib import Path
from typing import List, Optional

import utils

import matplotlib.pyplot as plt
import numpy as np
import yaml
from loguru import logger
from PIL import Image as PILImage
from rich.progress import track
from skimage.exposure import rescale_intensity
from skimage.io import imsave

import flir
import stitch
from misc import exif, tools
from misc.tools import ImageIO

CURRENT_DIR = Path(&#39;.&#39;).resolve()


class _DIR:
  RAW = &#39;Raw&#39;
  IR = &#39;IR&#39;
  VIS = &#39;VIS&#39;
  PANO = &#39;Panorama&#39;
  RGST = &#39;Registration&#39;
  SEG = &#39;Segmentation&#39;


class ThermalPanorama:
  # TODO: colormap

  def __init__(self, config) -&gt; None:
    config = Path(config).resolve()
    logger.debug(&#39;Config path: `{}`&#39;, config)
    if not config.exists():
      raise FileNotFoundError(config)

    with open(config, &#39;r&#39;, encoding=&#39;utf-8&#39;) as f:
      self._config: dict = yaml.safe_load(f)

    wd = Path(self._config[&#39;path&#39;][&#39;working_directory&#39;])
    if not wd.is_absolute():
      wd = config.parent.joinpath(wd).resolve()
    if not wd.exists():
      raise FileNotFoundError(wd)

    self._wd = wd
    self._exts = (self._config[&#39;path&#39;][&#39;save_ext&#39;][&#39;IR&#39;],
                  self._config[&#39;path&#39;][&#39;save_ext&#39;][&#39;VIS&#39;])

    self._manufacturer = self._check_manufacturer()
    self._flir_ext = flir.FlirExtractor()
    logger.debug(&#39;Manufacturer: {}&#39;, self._manufacturer)

  def _check_manufacturer(self) -&gt; str:
    raw_dir = self._dir(_DIR.RAW)

    flir_files = list(raw_dir.glob(self._config[&#39;path&#39;][&#39;FLIR&#39;][&#39;IR&#39;]))
    testo_ir_files = list(raw_dir.glob(self._config[&#39;path&#39;][&#39;testo&#39;][&#39;IR&#39;]))
    testo_vis_files = list(raw_dir.glob(self._config[&#39;path&#39;][&#39;testo&#39;][&#39;VIS&#39;]))

    if testo_ir_files and testo_vis_files:
      manufacturer = &#39;testo&#39;
    elif flir_files:
      manufacturer = &#39;FLIR&#39;
    else:
      raise ValueError(&#39;Raw 파일 설정 오류&#39;)

    return manufacturer

  def _files(self) -&gt; List[Path]:
    # FIXME Raw 폴더에 원본이 없는 경우에도 지원?
    pattern = self._config[&#39;path&#39;][self._manufacturer][&#39;IR&#39;]
    files = [x.resolve() for x in self._dir(_DIR.RAW).glob(pattern)]

    if not files:
      logger.warning(&#39;{} 폴더에 영상 파일이 존재하지 않습니다.&#39;, _DIR.RAW)

    return files

  @property
  def working_dir(self) -&gt; Path:
    return self._wd

  def _dir(self, folder: str):
    d = self.working_dir.joinpath(folder)
    if not d.exists():
      d.mkdir()

    return d

  def _extract_flir_image(self, path: Path):
    ir, vis = self._flir_ext.extract_data(path)
    meta = {&#39;Exif&#39;: exif.get_exif_tags(path.as_posix())[0]}

    # FIXME 임시로 만듬 - Exif Orientation 태그 정보에 따라 회전하기
    if ir.shape[0] &gt; ir.shape[1]:
      logger.debug(&#39;rot90 ({})&#39;, path.name)
      ir = np.rot90(ir, k=1, axes=(0, 1))
      vis = np.rot90(vis, k=1, axes=(0, 1))

    return ir, vis, meta

  def _extract_testo_image(self, path: Path):
    vis_suffix = self._config[&#39;path&#39;][&#39;testo&#39;][&#39;VIS&#39;].replace(&#39;*&#39;, &#39;&#39;)
    vis_path = path.with_name(path.stem + vis_suffix)
    if not vis_path.exists():
      raise FileNotFoundError(vis_path)

    ir = ImageIO.read_image(path=path)
    vis = ImageIO.read_image(path=vis_path)

    return ir, vis

  def _save_extracted_image(self,
                            fname: str,
                            ir: np.ndarray,
                            vis: np.ndarray,
                            meta: Optional[dict] = None):
    ir_path = self._dir(_DIR.IR).joinpath(fname)
    vis_path = self._dir(_DIR.VIS).joinpath(f&#39;{fname}{self._exts[1]}&#39;)

    ImageIO.save_image_and_meta(path=ir_path,
                                array=ir,
                                exts=[self._exts[0], &#39;.png&#39;],
                                scale=True,
                                meta=meta,
                                save_meta=True)

    ImageIO.save_image(path=vis_path, array=vis)

  def _read_file(self, file: Path):
    if not file.exists():
      raise FileNotFoundError(file)

    ir_path = self._dir(_DIR.IR).joinpath(file.stem + self._exts[0])
    vis_path = self._dir(_DIR.VIS).joinpath(file.stem + self._exts[1])

    if ir_path.exists() and vis_path.exists():
      ir = ImageIO.read_image(ir_path)
      vis = ImageIO.read_image(vis_path)
    else:
      logger.debug(&#39;Extracting `{}`&#39;, file.name)

      if self._manufacturer == &#39;FLIR&#39;:
        ir, vis, meta = self._extract_flir_image(path=file)
      elif self._manufacturer == &#39;testo&#39;:
        ir, vis = self._extract_testo_image(path=file)
        meta = None
      else:
        raise ValueError

      self._save_extracted_image(fname=file.stem, ir=ir, vis=vis, meta=meta)

      assert ir is not None

    return ir, vis

  def _iter_files(self):
    files = self._files()
    for file in files:
      ir, vis = self._read_file(file)

      yield ir, vis

  def _read_files(self):
    ir_images = []
    vis_images = []

    for ir, vis in track(self._iter_files(),
                         &#39;Reading...&#39;,
                         total=len(self._files()),
                         console=utils.console):
      ir_images.append(ir)
      vis_images.append(vis)

    return ir_images, vis_images

  def register(self):
    pass

  def segment(self):
    pass

  def panorama(self):
    wl = self._config[&#39;panorama&#39;][&#39;target&#39;].upper()
    if not wl in (&#39;IR&#39;, &#39;VIS&#39;):
      raise ValueError(wl)

    sopt: dict = self._config[&#39;panorama&#39;][&#39;stitch&#39;]
    popt: dict = self._config[&#39;panorama&#39;][&#39;preprocess&#39;][wl]

    pano_dir = self._dir(_DIR.PANO)
    pano_fname = &#39;panorama_&#39; + sopt[&#39;warp&#39;]
    if pano_dir.joinpath(pano_fname + &#39;.png&#39;).exists():
      logger.info(&#39;기 생성된 파노라마 파일이 존재합니다.&#39;)
      return

    ir_images, vis_images = self._read_files()
    images = ir_images if wl == &#39;IR&#39; else vis_images
    if not images:
      logger.warning(&#39;대상 영상이 없습니다.&#39;)
      return

    # 전처리
    prep = stitch.preprocess.PanoramaPreprocess(
        is_numeric=(images[0].ndim == 2),
        mask_threshold=popt[&#39;masking_threshold&#39;],
        contrast=popt[&#39;contrast&#39;],
        denoise=popt[&#39;denoise&#39;])
    if &#39;bilateral_args&#39; in popt:
      prep.set_bilateral_args(**popt[&#39;bilateral_args&#39;])
    if &#39;gaussian_args&#39; in popt:
      prep.set_gaussian_args(**popt[&#39;gaussian_args&#39;])

    # 영상
    stitching_images = stitch.stitcher.StitchingImages(arrays=images)
    stitching_images.set_preprocess(prep)
    logger.debug(&#39;Stitching: 대상 영상 &amp; 전처리 설정&#39;)

    # Stitcher
    stitcher = stitch.stitcher.Stitcher(mode=sopt[&#39;perspective&#39;],
                                        compose_scale=sopt[&#39;compose_scale&#39;],
                                        work_scale=sopt[&#39;work_scale&#39;],
                                        warp_threshold=sopt[&#39;warp_threshold&#39;])
    stitcher.warper_type = sopt[&#39;warp&#39;]
    logger.debug(&#39;Stitching: Stitcher 초기화&#39;)

    with utils.console.status(&#39;Stitching...&#39;):
      panorama, mask, graph, indices = stitcher.stitch(
          images=stitching_images,
          masks=None,
          image_names=[x.stem for x in self._files()])

    if self._config[&#39;panorama&#39;][&#39;stitch&#39;][&#39;crop&#39;]:
      logger.debug(&#39;Crop panorama&#39;)
      x1, x2, y1, y2 = tools.mask_bbox(mask=mask, morphology_open=True)
      panorama = panorama[y1:y2, x1:x2]
      mask = mask[y1:y2, x1:x2]

    with utils.console.status(&#39;Saving...&#39;):
      if wl == &#39;IR&#39;:
        meta = {
            &#39;panorama&#39;: {
                &#39;graph&#39;: graph,
                &#39;image_indices&#39;: indices.ravel().tolist()
            }
        }
        ImageIO.save_image_and_meta(
            path=pano_dir.joinpath(pano_fname),
            # array=np.round(panorama, 3),
            array=panorama.astype(np.float16),  # TODO 추출부터 float16으로
            exts=[&#39;.npy&#39;, &#39;.png&#39;],
            scale=True,
            meta=meta,
            save_meta=True)
      else:
        panorama_image = tools.uint8_image(panorama)
        ImageIO.save_image(
            path=pano_dir.joinpath(pano_fname).with_suffix(&#39;.jpg&#39;),
            array=panorama_image)

      ImageIO.save_image(path=pano_dir.joinpath(pano_fname + &#39;_mask.png&#39;),
                         array=rescale_intensity(mask, out_range=&#39;uint8&#39;))

    logger.info(&#39;파노라마 생성 완료&#39;)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="src.interface.pano.ThermalPanorama"><code class="flex name class">
<span>class <span class="ident">ThermalPanorama</span></span>
<span>(</span><span>config)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class ThermalPanorama:
  # TODO: colormap

  def __init__(self, config) -&gt; None:
    config = Path(config).resolve()
    logger.debug(&#39;Config path: `{}`&#39;, config)
    if not config.exists():
      raise FileNotFoundError(config)

    with open(config, &#39;r&#39;, encoding=&#39;utf-8&#39;) as f:
      self._config: dict = yaml.safe_load(f)

    wd = Path(self._config[&#39;path&#39;][&#39;working_directory&#39;])
    if not wd.is_absolute():
      wd = config.parent.joinpath(wd).resolve()
    if not wd.exists():
      raise FileNotFoundError(wd)

    self._wd = wd
    self._exts = (self._config[&#39;path&#39;][&#39;save_ext&#39;][&#39;IR&#39;],
                  self._config[&#39;path&#39;][&#39;save_ext&#39;][&#39;VIS&#39;])

    self._manufacturer = self._check_manufacturer()
    self._flir_ext = flir.FlirExtractor()
    logger.debug(&#39;Manufacturer: {}&#39;, self._manufacturer)

  def _check_manufacturer(self) -&gt; str:
    raw_dir = self._dir(_DIR.RAW)

    flir_files = list(raw_dir.glob(self._config[&#39;path&#39;][&#39;FLIR&#39;][&#39;IR&#39;]))
    testo_ir_files = list(raw_dir.glob(self._config[&#39;path&#39;][&#39;testo&#39;][&#39;IR&#39;]))
    testo_vis_files = list(raw_dir.glob(self._config[&#39;path&#39;][&#39;testo&#39;][&#39;VIS&#39;]))

    if testo_ir_files and testo_vis_files:
      manufacturer = &#39;testo&#39;
    elif flir_files:
      manufacturer = &#39;FLIR&#39;
    else:
      raise ValueError(&#39;Raw 파일 설정 오류&#39;)

    return manufacturer

  def _files(self) -&gt; List[Path]:
    # FIXME Raw 폴더에 원본이 없는 경우에도 지원?
    pattern = self._config[&#39;path&#39;][self._manufacturer][&#39;IR&#39;]
    files = [x.resolve() for x in self._dir(_DIR.RAW).glob(pattern)]

    if not files:
      logger.warning(&#39;{} 폴더에 영상 파일이 존재하지 않습니다.&#39;, _DIR.RAW)

    return files

  @property
  def working_dir(self) -&gt; Path:
    return self._wd

  def _dir(self, folder: str):
    d = self.working_dir.joinpath(folder)
    if not d.exists():
      d.mkdir()

    return d

  def _extract_flir_image(self, path: Path):
    ir, vis = self._flir_ext.extract_data(path)
    meta = {&#39;Exif&#39;: exif.get_exif_tags(path.as_posix())[0]}

    # FIXME 임시로 만듬 - Exif Orientation 태그 정보에 따라 회전하기
    if ir.shape[0] &gt; ir.shape[1]:
      logger.debug(&#39;rot90 ({})&#39;, path.name)
      ir = np.rot90(ir, k=1, axes=(0, 1))
      vis = np.rot90(vis, k=1, axes=(0, 1))

    return ir, vis, meta

  def _extract_testo_image(self, path: Path):
    vis_suffix = self._config[&#39;path&#39;][&#39;testo&#39;][&#39;VIS&#39;].replace(&#39;*&#39;, &#39;&#39;)
    vis_path = path.with_name(path.stem + vis_suffix)
    if not vis_path.exists():
      raise FileNotFoundError(vis_path)

    ir = ImageIO.read_image(path=path)
    vis = ImageIO.read_image(path=vis_path)

    return ir, vis

  def _save_extracted_image(self,
                            fname: str,
                            ir: np.ndarray,
                            vis: np.ndarray,
                            meta: Optional[dict] = None):
    ir_path = self._dir(_DIR.IR).joinpath(fname)
    vis_path = self._dir(_DIR.VIS).joinpath(f&#39;{fname}{self._exts[1]}&#39;)

    ImageIO.save_image_and_meta(path=ir_path,
                                array=ir,
                                exts=[self._exts[0], &#39;.png&#39;],
                                scale=True,
                                meta=meta,
                                save_meta=True)

    ImageIO.save_image(path=vis_path, array=vis)

  def _read_file(self, file: Path):
    if not file.exists():
      raise FileNotFoundError(file)

    ir_path = self._dir(_DIR.IR).joinpath(file.stem + self._exts[0])
    vis_path = self._dir(_DIR.VIS).joinpath(file.stem + self._exts[1])

    if ir_path.exists() and vis_path.exists():
      ir = ImageIO.read_image(ir_path)
      vis = ImageIO.read_image(vis_path)
    else:
      logger.debug(&#39;Extracting `{}`&#39;, file.name)

      if self._manufacturer == &#39;FLIR&#39;:
        ir, vis, meta = self._extract_flir_image(path=file)
      elif self._manufacturer == &#39;testo&#39;:
        ir, vis = self._extract_testo_image(path=file)
        meta = None
      else:
        raise ValueError

      self._save_extracted_image(fname=file.stem, ir=ir, vis=vis, meta=meta)

      assert ir is not None

    return ir, vis

  def _iter_files(self):
    files = self._files()
    for file in files:
      ir, vis = self._read_file(file)

      yield ir, vis

  def _read_files(self):
    ir_images = []
    vis_images = []

    for ir, vis in track(self._iter_files(),
                         &#39;Reading...&#39;,
                         total=len(self._files()),
                         console=utils.console):
      ir_images.append(ir)
      vis_images.append(vis)

    return ir_images, vis_images

  def register(self):
    pass

  def segment(self):
    pass

  def panorama(self):
    wl = self._config[&#39;panorama&#39;][&#39;target&#39;].upper()
    if not wl in (&#39;IR&#39;, &#39;VIS&#39;):
      raise ValueError(wl)

    sopt: dict = self._config[&#39;panorama&#39;][&#39;stitch&#39;]
    popt: dict = self._config[&#39;panorama&#39;][&#39;preprocess&#39;][wl]

    pano_dir = self._dir(_DIR.PANO)
    pano_fname = &#39;panorama_&#39; + sopt[&#39;warp&#39;]
    if pano_dir.joinpath(pano_fname + &#39;.png&#39;).exists():
      logger.info(&#39;기 생성된 파노라마 파일이 존재합니다.&#39;)
      return

    ir_images, vis_images = self._read_files()
    images = ir_images if wl == &#39;IR&#39; else vis_images
    if not images:
      logger.warning(&#39;대상 영상이 없습니다.&#39;)
      return

    # 전처리
    prep = stitch.preprocess.PanoramaPreprocess(
        is_numeric=(images[0].ndim == 2),
        mask_threshold=popt[&#39;masking_threshold&#39;],
        contrast=popt[&#39;contrast&#39;],
        denoise=popt[&#39;denoise&#39;])
    if &#39;bilateral_args&#39; in popt:
      prep.set_bilateral_args(**popt[&#39;bilateral_args&#39;])
    if &#39;gaussian_args&#39; in popt:
      prep.set_gaussian_args(**popt[&#39;gaussian_args&#39;])

    # 영상
    stitching_images = stitch.stitcher.StitchingImages(arrays=images)
    stitching_images.set_preprocess(prep)
    logger.debug(&#39;Stitching: 대상 영상 &amp; 전처리 설정&#39;)

    # Stitcher
    stitcher = stitch.stitcher.Stitcher(mode=sopt[&#39;perspective&#39;],
                                        compose_scale=sopt[&#39;compose_scale&#39;],
                                        work_scale=sopt[&#39;work_scale&#39;],
                                        warp_threshold=sopt[&#39;warp_threshold&#39;])
    stitcher.warper_type = sopt[&#39;warp&#39;]
    logger.debug(&#39;Stitching: Stitcher 초기화&#39;)

    with utils.console.status(&#39;Stitching...&#39;):
      panorama, mask, graph, indices = stitcher.stitch(
          images=stitching_images,
          masks=None,
          image_names=[x.stem for x in self._files()])

    if self._config[&#39;panorama&#39;][&#39;stitch&#39;][&#39;crop&#39;]:
      logger.debug(&#39;Crop panorama&#39;)
      x1, x2, y1, y2 = tools.mask_bbox(mask=mask, morphology_open=True)
      panorama = panorama[y1:y2, x1:x2]
      mask = mask[y1:y2, x1:x2]

    with utils.console.status(&#39;Saving...&#39;):
      if wl == &#39;IR&#39;:
        meta = {
            &#39;panorama&#39;: {
                &#39;graph&#39;: graph,
                &#39;image_indices&#39;: indices.ravel().tolist()
            }
        }
        ImageIO.save_image_and_meta(
            path=pano_dir.joinpath(pano_fname),
            # array=np.round(panorama, 3),
            array=panorama.astype(np.float16),  # TODO 추출부터 float16으로
            exts=[&#39;.npy&#39;, &#39;.png&#39;],
            scale=True,
            meta=meta,
            save_meta=True)
      else:
        panorama_image = tools.uint8_image(panorama)
        ImageIO.save_image(
            path=pano_dir.joinpath(pano_fname).with_suffix(&#39;.jpg&#39;),
            array=panorama_image)

      ImageIO.save_image(path=pano_dir.joinpath(pano_fname + &#39;_mask.png&#39;),
                         array=rescale_intensity(mask, out_range=&#39;uint8&#39;))

    logger.info(&#39;파노라마 생성 완료&#39;)</code></pre>
</details>
<h3>Instance variables</h3>
<dl>
<dt id="src.interface.pano.ThermalPanorama.working_dir"><code class="name">var <span class="ident">working_dir</span> : pathlib.Path</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@property
def working_dir(self) -&gt; Path:
  return self._wd</code></pre>
</details>
</dd>
</dl>
<h3>Methods</h3>
<dl>
<dt id="src.interface.pano.ThermalPanorama.panorama"><code class="name flex">
<span>def <span class="ident">panorama</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def panorama(self):
  wl = self._config[&#39;panorama&#39;][&#39;target&#39;].upper()
  if not wl in (&#39;IR&#39;, &#39;VIS&#39;):
    raise ValueError(wl)

  sopt: dict = self._config[&#39;panorama&#39;][&#39;stitch&#39;]
  popt: dict = self._config[&#39;panorama&#39;][&#39;preprocess&#39;][wl]

  pano_dir = self._dir(_DIR.PANO)
  pano_fname = &#39;panorama_&#39; + sopt[&#39;warp&#39;]
  if pano_dir.joinpath(pano_fname + &#39;.png&#39;).exists():
    logger.info(&#39;기 생성된 파노라마 파일이 존재합니다.&#39;)
    return

  ir_images, vis_images = self._read_files()
  images = ir_images if wl == &#39;IR&#39; else vis_images
  if not images:
    logger.warning(&#39;대상 영상이 없습니다.&#39;)
    return

  # 전처리
  prep = stitch.preprocess.PanoramaPreprocess(
      is_numeric=(images[0].ndim == 2),
      mask_threshold=popt[&#39;masking_threshold&#39;],
      contrast=popt[&#39;contrast&#39;],
      denoise=popt[&#39;denoise&#39;])
  if &#39;bilateral_args&#39; in popt:
    prep.set_bilateral_args(**popt[&#39;bilateral_args&#39;])
  if &#39;gaussian_args&#39; in popt:
    prep.set_gaussian_args(**popt[&#39;gaussian_args&#39;])

  # 영상
  stitching_images = stitch.stitcher.StitchingImages(arrays=images)
  stitching_images.set_preprocess(prep)
  logger.debug(&#39;Stitching: 대상 영상 &amp; 전처리 설정&#39;)

  # Stitcher
  stitcher = stitch.stitcher.Stitcher(mode=sopt[&#39;perspective&#39;],
                                      compose_scale=sopt[&#39;compose_scale&#39;],
                                      work_scale=sopt[&#39;work_scale&#39;],
                                      warp_threshold=sopt[&#39;warp_threshold&#39;])
  stitcher.warper_type = sopt[&#39;warp&#39;]
  logger.debug(&#39;Stitching: Stitcher 초기화&#39;)

  with utils.console.status(&#39;Stitching...&#39;):
    panorama, mask, graph, indices = stitcher.stitch(
        images=stitching_images,
        masks=None,
        image_names=[x.stem for x in self._files()])

  if self._config[&#39;panorama&#39;][&#39;stitch&#39;][&#39;crop&#39;]:
    logger.debug(&#39;Crop panorama&#39;)
    x1, x2, y1, y2 = tools.mask_bbox(mask=mask, morphology_open=True)
    panorama = panorama[y1:y2, x1:x2]
    mask = mask[y1:y2, x1:x2]

  with utils.console.status(&#39;Saving...&#39;):
    if wl == &#39;IR&#39;:
      meta = {
          &#39;panorama&#39;: {
              &#39;graph&#39;: graph,
              &#39;image_indices&#39;: indices.ravel().tolist()
          }
      }
      ImageIO.save_image_and_meta(
          path=pano_dir.joinpath(pano_fname),
          # array=np.round(panorama, 3),
          array=panorama.astype(np.float16),  # TODO 추출부터 float16으로
          exts=[&#39;.npy&#39;, &#39;.png&#39;],
          scale=True,
          meta=meta,
          save_meta=True)
    else:
      panorama_image = tools.uint8_image(panorama)
      ImageIO.save_image(
          path=pano_dir.joinpath(pano_fname).with_suffix(&#39;.jpg&#39;),
          array=panorama_image)

    ImageIO.save_image(path=pano_dir.joinpath(pano_fname + &#39;_mask.png&#39;),
                       array=rescale_intensity(mask, out_range=&#39;uint8&#39;))

  logger.info(&#39;파노라마 생성 완료&#39;)</code></pre>
</details>
</dd>
<dt id="src.interface.pano.ThermalPanorama.register"><code class="name flex">
<span>def <span class="ident">register</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def register(self):
  pass</code></pre>
</details>
</dd>
<dt id="src.interface.pano.ThermalPanorama.segment"><code class="name flex">
<span>def <span class="ident">segment</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def segment(self):
  pass</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="src.interface" href="index.html">src.interface</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="src.interface.pano.ThermalPanorama" href="#src.interface.pano.ThermalPanorama">ThermalPanorama</a></code></h4>
<ul class="">
<li><code><a title="src.interface.pano.ThermalPanorama.panorama" href="#src.interface.pano.ThermalPanorama.panorama">panorama</a></code></li>
<li><code><a title="src.interface.pano.ThermalPanorama.register" href="#src.interface.pano.ThermalPanorama.register">register</a></code></li>
<li><code><a title="src.interface.pano.ThermalPanorama.segment" href="#src.interface.pano.ThermalPanorama.segment">segment</a></code></li>
<li><code><a title="src.interface.pano.ThermalPanorama.working_dir" href="#src.interface.pano.ThermalPanorama.working_dir">working_dir</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.9.2</a>.</p>
</footer>
</body>
</html>